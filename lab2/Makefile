# Makefile
.DEFAULT_GOAL := all

# –ü—É—Ç–∏ –∫ –¥–∞–Ω–Ω—ã–º –∏ –º–æ–¥–µ–ª—è–º
DATA_GEN_DIR := ../lab1/data_gen
DATA_DIR := ../lab1/data
MODELS_DIR := ../lab1/models
JENKINS_DIR := ./jenkins
JENKINS_HOME := ./jenkins_home

all: setup start-jenkins wait-for-jenkins run-pipeline

setup: create-dirs copy-requirements build-jenkins build-ml

create-dirs:
	@mkdir -p $(DATA_GEN_DIR) $(DATA_DIR) $(MODELS_DIR) $(JENKINS_HOME)
	@mkdir -p $(JENKINS_DIR)/init.groovy.d
	@echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω—ã"

copy-requirements:
	@cp ../lab1/requirements.txt .
	@echo "‚úÖ requirements.txt —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω"

build-jenkins:
	@docker compose build jenkins
	@echo "‚úÖ Jenkins –æ–±—Ä–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω"

build-ml:
	@docker compose build ml-pipeline
	@echo "‚úÖ ML pipeline –æ–±—Ä–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω"

start-jenkins:
	@docker compose up -d jenkins
	@echo "üöÄ Jenkins –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ..."

wait-for-jenkins:
	@echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Jenkins (120 —Å–µ–∫—É–Ω–¥)..."
	@for i in {1..12}; do \
		sleep 10; \
		echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ... $$(($$i * 10)) —Å–µ–∫—É–Ω–¥ –∏–∑ 120"; \
		if curl -s http://localhost:8089/jenkins/login > /dev/null; then \
			echo "‚úÖ Jenkins –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ"; \
			break; \
		fi; \
	done
	@echo "üîó Jenkins –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:8089/jenkins"
	@echo "üîë –õ–æ–≥–∏–Ω: admin, –ü–∞—Ä–æ–ª—å: admin"

run-pipeline:
	@docker compose up --force-recreate --no-deps ml-pipeline
	@echo "‚úÖ ML Pipeline —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω"

jenkins-logs:
	@docker compose logs -f jenkins

ml-logs:
	@docker compose logs -f ml-pipeline

jenkins-console:
	@docker exec -it jenkins_lab2 bash

clean-data:
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö..."
	@rm -rf $(DATA_GEN_DIR)/* $(DATA_DIR)/* $(MODELS_DIR)/* 2>/dev/null || true
	@echo "‚úÖ –î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã"

clear-all: clean-data
	@echo "üî• –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞..."
	@docker compose down -v --remove-orphans
	@docker image prune -f
	@rm -rf $(JENKINS_HOME) $(JENKINS_DIR)/init.groovy.d/*.groovy
	@rm -f requirements.txt
	@echo "‚úÖ –í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –æ–±—Ä–∞–∑—ã –∏ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã"

.PHONY: all setup create-dirs copy-requirements build-jenkins build-ml start-jenkins wait-for-jenkins run-pipeline jenkins-logs ml-logs jenkins-console clean-data clear-all